name: Build Docusaurus Docs

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
    pull-docs:
        runs-on: ubuntu-latest
        steps:
              - name: Checkout Main Repository
                uses: actions/checkout@v4
                with:
                  submodules: true  # Ensures submodules are initialized
                  fetch-depth: 0
        
              - name: Make fetch_docs.sh Executable
                run: chmod +x scripts/fetch_docs.sh
        
              - name: Fetch All Docs
                run: ./scripts/fetch_docs.sh
        
              - name: Clear Destination Directory
                run: rm -rf docs/docs

              - name: Clone Documentation Repository
                run: git clone https://github.com/pvarki/docker-rasenmaeher-integration.git docs/docs
        
              - name: Upload Docs Artifact
                uses: actions/upload-artifact@v4
                with:
                  name: docs-raw
                  path: docs/docs/

    build:
        runs-on: ubuntu-latest
        needs: pull-docs
        steps:
              - name: Checkout Documentation Repo
                uses: actions/checkout@v4
        
              - name: Download Docs Artifact
                uses: actions/download-artifact@v4
                with:
                  name: docs-raw
                  path: docs/docs/
        
              - name: Install Docusaurus
                run: |
                  npm install --global docusaurus-init
                  npm install
                  
              - name: Debug
                run: | 
                  ls -la docs/docs
                  ls -R 
        
              - name: Build Docusaurus Docs
                run: |
                  cd docs
                  npm run build
        
              - name: Package Docs for External Software
                run: |
                  tar -czf built-docs.tar.gz -C docs/docs/build .
        
              - name: Upload Built Docs
                uses: actions/upload-artifact@v4
                with:
                  name: built-docs
                  path: built-docs.tar.gz