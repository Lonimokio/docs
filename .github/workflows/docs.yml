name: Build Docusaurus Docs

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
    pull-docs:
        runs-on: ubuntu-latest
        steps:
              - name: Checkout Main Repository
                uses: actions/checkout@v4
                with:
                  submodules: true  # Ensures submodules are initialized
                  fetch-depth: 0
        
              - name: Make fetch_docs.sh Executable
                run: chmod +x ${{ github.workspace }}/scripts/fetch_docs.sh
        
              - name: Fetch All Docs
                run: ${{ github.workspace }}/scripts/fetch_docs.sh
        
              - name: Clear Destination Directory
                run: rm -rf ${{ github.workspace }}/MainDocs/docs

              - name: Clone Documentation Repository
                run: git clone https://github.com/pvarki/docker-rasenmaeher-integration.git ${{ github.workspace }}/MainDocs/docs

              - name: Debug
                run: | 
                  ls -R ${{ github.workspace }}/MainDocs
                  ls
        
              - name: Upload Docs Artifact
                uses: actions/upload-artifact@v4
                with:
                  name: docs-raw
                  path: ${{ github.workspace }}/MainDocs/docs/

    build:
        runs-on: ubuntu-latest
        needs: pull-docs
        steps:
              - name: Checkout Documentation Repo
                uses: actions/checkout@v4
        
              - name: Download Docs Artifact
                uses: actions/download-artifact@v4
                with:
                  name: docs-raw
                  path: ${{ github.workspace }}/MainDocs/docs/
        
              - name: Install Docusaurus
                run: |
                  npm install --global docusaurus-init
                  npm install
        
              - name: Build Docusaurus Docs
                run: |
                  npm run build 
                working-directory: ${{ github.workspace }}/MainDocs
        
              - name: Package Docs for External Software
                run: |
                  tar -czf ${{ github.workspace }}/built-docs.tar.gz -C ${{ github.workspace }}/MainDocs/docs/build .
        
              - name: Upload Built Docs
                uses: actions/upload-artifact@v4
                with:
                  name: built-docs
                  path: ${{ github.workspace }}/built-docs.tar.gz